/**
 * Unit tests for Nmap Exploit Analyzer logic
 * Run with: node nmap-exploit-analyzer.test.js
 */

// Extract the logic from the React component for testing
const exploitDatabase = {
  'vsftpd 2.3.4': {
    cve: 'CVE-2011-2523',
    exploits: ['Metasploit: exploit/unix/ftp/vsftpd_234_backdoor'],
    severity: 'Critical',
    description: 'Backdoor command execution vulnerability',
    mitigation: 'Update to vsftpd 3.0.0 or later'
  },
  'openssh 7.2': {
    cve: 'CVE-2016-6210',
    exploits: ['Username enumeration via timing attack'],
    severity: 'Medium',
    description: 'User enumeration vulnerability',
    mitigation: 'Update to OpenSSH 7.3 or later'
  },
  'apache 2.4.7': {
    cve: 'CVE-2017-9798',
    exploits: ['Optionsbleed memory leak'],
    severity: 'Medium',
    description: 'Memory disclosure vulnerability',
    mitigation: 'Update to Apache 2.4.28 or later'
  },
  'mysql 5.5': {
    cve: 'Multiple',
    exploits: ['Weak authentication', 'SQL injection potential'],
    severity: 'High',
    description: 'Older version with known vulnerabilities',
    mitigation: 'Update to MySQL 5.7 or 8.0'
  },
  'samba 3.0.20': {
    cve: 'CVE-2007-2447',
    exploits: ['Metasploit: exploit/multi/samba/usermap_script'],
    severity: 'Critical',
    description: 'Remote command execution in username map script',
    mitigation: 'Update to Samba 3.0.25 or later'
  }
};

// Parsing function
const parseNmapResults = (text) => {
  const lines = text.split('\n');
  const hosts = [];
  let currentHost = null;
  let currentPorts = [];

  for (let line of lines) {
    // Parse host
    const hostMatch = line.match(/Nmap scan report for ([\w\.-]+)(?:\s+\(([\d\.]+)\))?/i);
    if (hostMatch) {
      if (currentHost) {
        hosts.push({ ...currentHost, ports: currentPorts });
      }
      currentHost = {
        hostname: hostMatch[1],
        ip: hostMatch[2] || hostMatch[1]
      };
      currentPorts = [];
      continue;
    }

    // Parse ports and services
    const portMatch = line.match(/(\d+)\/(\w+)\s+(\w+)\s+(\S+)(?:\s+(.*))?/);
    if (portMatch && currentHost) {
      const [, port, protocol, state, service, version] = portMatch;
      if (state === 'open') {
        currentPorts.push({
          port,
          protocol,
          service,
          version: version || 'unknown'
        });
      }
    }
  }

  if (currentHost) {
    hosts.push({ ...currentHost, ports: currentPorts });
  }

  return hosts;
};

// Exploit finding function
const findExploits = (service, version) => {
  const searchKey = `${service} ${version}`.toLowerCase();
  
  // Direct match
  for (let [key, exploit] of Object.entries(exploitDatabase)) {
    if (searchKey.includes(key.toLowerCase())) {
      return exploit;
    }
  }

  // Service-only match
  for (let [key, exploit] of Object.entries(exploitDatabase)) {
    if (searchKey.includes(key.split(' ')[0].toLowerCase()) && key.includes(' ')) {
      return { ...exploit, note: 'Version match not exact - verify manually' };
    }
  }

  return null;
};

// ============ TEST SUITE ============

let testsPassed = 0;
let testsFailed = 0;

function assert(condition, message) {
  if (condition) {
    console.log(`‚úì ${message}`);
    testsPassed++;
  } else {
    console.log(`‚úó ${message}`);
    testsFailed++;
  }
}

console.log('\n========================================');
console.log('  NMAP EXPLOIT ANALYZER - TEST SUITE');
console.log('========================================\n');

// Test 1: Parse single host with ports
console.log('Test Group 1: Parsing Nmap Results');
const sampleNmap = `Starting Nmap 7.94 ( https://nmap.org )
Nmap scan report for target.mentormaze.local (172.20.0.5)
Host is up (0.00023s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.2
80/tcp   open  http        Apache httpd 2.4.7`;

const parsed = parseNmapResults(sampleNmap);
assert(parsed.length === 1, '1.1 - Should parse exactly 1 host');
assert(parsed[0].hostname === 'target.mentormaze.local', '1.2 - Should extract hostname correctly');
assert(parsed[0].ip === '172.20.0.5', '1.3 - Should extract IP correctly');
assert(parsed[0].ports.length === 3, '1.4 - Should parse 3 open ports');
assert(parsed[0].ports[0].port === '21', '1.5 - Should extract port 21');
assert(parsed[0].ports[0].service === 'ftp', '1.6 - Should extract FTP service');
assert(parsed[0].ports[0].version === 'vsftpd 2.3.4', '1.7 - Should extract vsftpd version');

// Test 2: Exploit matching
console.log('\nTest Group 2: Exploit Matching');
const vsftpdExploit = findExploits('ftp', 'vsftpd 2.3.4');
assert(vsftpdExploit !== null, '2.1 - Should find exploit for vsftpd 2.3.4');
assert(vsftpdExploit.cve === 'CVE-2011-2523', '2.2 - Should match correct CVE');
assert(vsftpdExploit.severity === 'Critical', '2.3 - Should identify Critical severity');
assert(vsftpdExploit.exploits.length > 0, '2.4 - Should have exploit suggestions');

// Test 3: SSH exploit
const sshExploit = findExploits('ssh', 'OpenSSH 7.2p2');
assert(sshExploit !== null, '2.5 - Should find exploit for OpenSSH 7.2');
assert(sshExploit.cve === 'CVE-2016-6210', '2.6 - Should match OpenSSH CVE');

// Test 4: Multiple hosts parsing
console.log('\nTest Group 3: Multiple Hosts Parsing');
const multiHostNmap = `Nmap scan report for host1.com (192.168.1.1)
HOST is up
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.2p2
80/tcp   open  http        Apache httpd 2.4.7

Nmap scan report for host2.com (192.168.1.2)
HOST is up
PORT     STATE SERVICE     VERSION
3306/tcp open  mysql       MySQL 5.5.62`;

const multiParsed = parseNmapResults(multiHostNmap);
assert(multiParsed.length === 2, '3.1 - Should parse 2 hosts');
assert(multiParsed[0].hostname === 'host1.com', '3.2 - Should parse first host name');
assert(multiParsed[1].hostname === 'host2.com', '3.3 - Should parse second host name');
assert(multiParsed[0].ports.length === 2, '3.4 - First host should have 2 ports');
assert(multiParsed[1].ports.length === 1, '3.5 - Second host should have 1 port');

// Test 5: Service without exact version match
console.log('\nTest Group 4: Partial Match Handling');
const partialMatch = findExploits('ssh', 'OpenSSH 5.0');
assert(partialMatch !== null, '4.1 - Should find generic SSH service info');

// Test 6: Unknown service
const unknownService = findExploits('unknown', '1.0.0');
assert(unknownService === null, '4.2 - Should return null for unknown service');

// ============ RESULTS ============
console.log('\n========================================');
console.log('  TEST RESULTS');
console.log('========================================');
console.log(`‚úì Passed: ${testsPassed}`);
console.log(`‚úó Failed: ${testsFailed}`);
console.log(`Total:  ${testsPassed + testsFailed}`);

if (testsFailed === 0) {
  console.log('\nüéâ All tests passed!\n');
  process.exit(0);
} else {
  console.log(`\n‚ö†Ô∏è  ${testsFailed} test(s) failed\n`);
  process.exit(1);
}
